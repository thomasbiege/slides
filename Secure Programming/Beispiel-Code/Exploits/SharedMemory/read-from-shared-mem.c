#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#include "errormsg.h"

int	debug_level;

#define USAGE(prog)	{ \
				fprintf(stderr, "usage: %s -k <shm key> -i <shm id>\n", prog);	\
				 exit(-1);	\
			}

int main(int argc, char **argv)
{
	char			*shm_addr;
	int			i,
				cmd,
				shm_id = -1;
	key_t			shm_key = -1;
	struct shmid_ds		shm_stat;


	// get options
	opterr = 0;
	while((cmd = getopt(argc, argv, "dk:i:")) != EOF)
	{
		switch(cmd)
		{
			case 'd':
				debug_level++;
			break;
			case 'k':
				if(optarg == NULL)
					goto DEFAULT;
				shm_key = (key_t) atoi(optarg);
			break;
			case 'i':
				if(optarg == NULL)
					goto DEFAULT;
				shm_id = atoi(optarg);
			break;
			default:
			DEFAULT:
				USAGE(argv[0])
		}
	}

	if(shm_id < 0)
		USAGE(argv[0])


	/* let's try to get some info of the specified shm area */
	if(shmctl(shm_id, IPC_STAT, &shm_stat) < 0)
		err_mesg(FATAL_SYS, "Can't get status for shared memory with id %d", shm_id);

	/* let's try to attach to the shm area */
	if( (shm_addr = (char *) shmat(shm_id, NULL, SHM_RDONLY)) == (void *) -1)
		err_mesg(FATAL_SYS, "Can't attach to shared memory with id %d", shm_id);

	for(i = 0; i < shm_stat.shm_segsz; i++)
		putchar(shm_addr[i]);

	shmdt((void *) shm_addr);

	exit(0);
}
