#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#include "errormsg.h"

int	debug_level;

char	*file = "/etc/passwd";

#define USAGE(prog)	{ \
				fprintf(stderr, "usage: %s -k <shm key> -i <shm id>\n", prog);	\
				 exit(-1);	\
			}


int main(int argc, char **argv)
{
	char			*shm_addr;
	int			i,
				fd,
				cmd,
				shm_id = -1;
	key_t			shm_key = -1;
	struct shmid_ds		shm_stat;
	struct stat		stat_buf;


	// get options
	opterr = 0;
	while((cmd = getopt(argc, argv, "df:")) != EOF)
	{
		switch(cmd)
		{
			case 'd':
				debug_level++;
			break;
			case 'f':
				if(optarg == NULL)
					goto DEFAULT;
				file = strdup(optarg);
			break;
			default:
			DEFAULT:
				USAGE(argv[0])
		}
	}


	/* open file */
	if( (fd = open(file, O_RDONLY)) < 0)
		err_mesg(FATAL_SYS, "Error opening file %s", file);

	/* getting status */
	if(fstat(fd, &stat_buf) < 0)
		err_mesg(FATAL_SYS, "Error while getting file status of file %s", file);

	/* creating shm */
	if( (shm_id = shmget(0, stat_buf.st_size,  S_IRWXU | 654 | IPC_CREAT | IPC_EXCL)) < 0)
		err_mesg(FATAL_SYS, "Error while creating shm");

	/* attach shm */
	if( (shm_addr = (char *) shmat(shm_id, NULL, 0)) == (void *) -1)
		err_mesg(FATAL_SYS, "Error while attaching shm");

        /* copy data */
	if(read(fd, (void *)shm_addr, stat_buf.st_size) < 0)
		err_mesg(FATAL_SYS, "Error copying data to shm");

	exit(0);
}
