
u_short *getports(char *origexpr)
{
  int exlen = strlen(origexpr);
  char *p,*q;
  unsigned short *tmp, *ports;
  int i=0, j=0,start,end;
  char *expr = strdup(origexpr);
  char *mem = expr;

  ports = (u_short *) malloc(65536 * sizeof(short));

  for(;j < exlen; j++)
    if (expr[j] != ' ') expr[i++] = expr[j];

  expr[i] = '\0';
  exlen = i;
  i=0;

  while((p = strchr(expr,',')))
  {
    *p = '\0';
    if (*expr == '-')
    {
      start = 1;
      end = atoi(expr+ 1);
    }
    else
    {
      start = end = atoi(expr);
      if ((q = strchr(expr,'-')) && *(q+1) )
        end = atoi(q + 1);
      else if (q && !*(q+1))
        end = 65535;
    }

    if (start < 1 || start > end)
      err_mesg(FATAL, "Your port specifications are illegal!");

    for(j=start; j <= end; j++)
      ports[i++] = j;
    expr = p + 1;
  }

  if (*expr == '-')
  {
    start = 1;
    end = atoi(expr+ 1);
  }
  else
  {
    start = end = atoi(expr);
    if ((q =  strchr(expr,'-')) && *(q+1) )
      end = atoi(q+1);
    else if (q && !*(q+1))
      end = 65535;
  }

  if (start < 1 || start > end)
    err_mesg(FATAL, "Your port specifications are illegal!");

  for(j=start; j <= end; j++)
    ports[i++] = j;

  ports[i++] = 0;
  tmp = realloc(ports, i * sizeof(short));
  free(mem);

  return(tmp);
}

