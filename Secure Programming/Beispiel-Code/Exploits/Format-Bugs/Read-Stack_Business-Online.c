/*
** Format-Bug Demonstration fuer "Business-Online Messe"
** Finden eines Strings im Stack, kein Schreiben.
** 2001-11-17
** Thomas Biege tom@electric-sheep.org
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <getopt.h>
#include <sys/types.h>


u_int debug_flag = 0;


int main(int argc, char **argv)
{
  int   opt,
        i;
  char  user_input[100],
        format_string[150],
        superuser_password[] = "supa"; // 0x73 0x75 0x70 0x61


  /*
  ** Argumente lesen
  */
  opterr = 0;
  while( (opt = getopt(argc, argv, "d")) != EOF)
  {
    switch (opt)
    {
      case 'd':
      debug_flag++;
      break;
    }
  }


  /*
  ** Debug
  */
  if(debug_flag)
  {
    printf("Debug: Superuser Password '%s' in Hex:\n", superuser_password);
    for(i = 0; i <= strlen(superuser_password); i++)
      printf("0x%02x|", (u_char) superuser_password[i]);
    putchar('\n');
    for(i = strlen(superuser_password); i >= 0; i--)
      printf("0x%02x|", (u_char) superuser_password[i]);
    putchar('\n');
    printf("Debug: &superuser_password = 0x%08x | &user_input = 0x%08x | Diff = 0x%08x (%d)\n\n", superuser_password, user_input, user_input - superuser_password, user_input - superuser_password);
  }


  /*
  ** Passwort-Prompt und Eingabe lesen
  */
  printf("\nSystem Login\n\nBitte geben Sie ihr Passwort ein: ");
  fgets(user_input, sizeof(user_input), stdin);


  /*
  ** Debug
  */
  if(debug_flag)
    printf("\nDebug: user_input: %s\n", user_input);


  /*
  ** Passwort ueberpruefen
  */
  if(strncmp(superuser_password, user_input, strlen(superuser_password)) != 0)
  {
    // Passwort ist falsch!
    sprintf(format_string, "Falsches Passwort: %s\n", user_input);
    printf(format_string);
    exit(0);
  }
  else
  {
    // Passwort ist richtig!
    system("clear");
    printf("\t\tW i l l k o m m e n   i m   S y s t e m !\n");
    unsetenv("PS1");
    putenv("PS1=SuperUser-Login #");
    system("/bin/bash --norc --noprofile");
    exit(1);
  }

  exit(-1);
}
